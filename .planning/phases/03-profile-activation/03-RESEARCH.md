# Phase 3: Profile Activation - Research

**Researched:** 2026-02-14
**Domain:** CLI orchestration workflow, consent UX, Claude Code command file generation, CLAUDE.md section management, artifact selection UI
**Confidence:** HIGH

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions

#### Consent & onboarding flow
- Consent screen combines casual headline with detailed breakdown
- Open with value proposition: why a learned profile beats vanilla Claude settings -- Claude adapts to YOUR style instead of starting generic every time
- Show the 8 behavioral dimensions being analyzed (communication style, decision speed, etc.)
- Include data handling details: what's read, what's stored, what's NOT sent anywhere, sensitive content skipped
- Sell the approach: "This learns how you actually work vs. configuring settings manually"
- After consent, show step-by-step progress: "Scanning sessions..." -> "Sampling messages..." -> "Analyzing patterns..." -> "Writing profile..."

#### Profile result display
- Show a summary card (report card style) with each dimension, rating, and confidence
- Include highlight reel: 3-4 most interesting findings with evidence quotes ("You tend to...")
- Offer option to expand to full USER-PROFILE.md view
- Then proceed to artifact selection

#### Orchestration modes
- Default (no flags): auto-detect sessions, proceed to analysis after consent. Falls back per Phase 2 rules: below 50 messages = hybrid (analyze + questionnaire supplement), zero sessions = questionnaire-only
- `--questionnaire`: skips session analysis entirely, questionnaire-only path (ACTV-02)
- `--refresh`: rebuilds profile even when one exists (ACTV-03). Saves old profile as USER-PROFILE.backup.md, regenerates fresh, shows compact diff of dimensions that changed rating/confidence
- Contradictory signals (context-dependent splits): present quick choice per split. Show the split with concrete examples ("You're terse in CLI projects, detailed in frontend"), offer options including "context-dependent" as a valid choice the profile can capture

#### Artifact selection & output
- After profile generation, present artifact selection (multiSelect) with ALL artifacts pre-selected by default
- Available artifacts: /gsd:dev-preferences command file, CLAUDE.md profile section, global CLAUDE.md
- Generate all selected artifacts in parallel (parallel agents), then show combined summary with paths
- No "test it out" step -- just summarize created artifacts and done
- When CLAUDE.md already exists: add/update profile section only, leave everything else untouched

#### /gsd:dev-preferences command file
- **Namespace override (ACTV-04):** `/gsd:dev-preferences` in GSD namespace, NOT top-level. Path: `~/.claude/commands/gsd/dev-preferences.md`
- Rationale: it's part of the GSD workflow ecosystem, not a standalone personal tool. Generated by GSD, consumed by GSD workflows, adapts the entire GSD experience
- Static .md file with baked-in directives (generated once, regenerated on --refresh)
- Content: all 8 behavioral dimensions as imperative instructions + stack/tool preferences
- Stack preferences sourced from BOTH session analysis (inferred from what frameworks/tools the dev actually uses) AND questionnaire (explicit preferences). Merge both signals.
- The command file serves dual purpose: (1) manual trigger to load preferences in any session, (2) source artifact that later integration phases reference

### Claude's Discretion
- Exact consent screen copy and layout
- Progress indicator implementation (spinner, status lines, etc.)
- How the summary card is formatted (table, cards, etc.)
- Backup file naming convention for --refresh
- Parallel agent orchestration for artifact generation
- How stack preferences are structured within the command file

### Deferred Ideas (OUT OF SCOPE)
- Automatic profile loading in all GSD workflows without manual /gsd:dev-preferences -- Phase 8 (Integration)
- CLAUDE.md auto-populated with profile sections -- Phase 4 (CLAUDE.md Generation)
- Phase brief assembly including profile content for researcher/planner agents -- Phase 5 (Phase Brief Assembly)
- Stack preference questions added to questionnaire -- requires Phase 2 questionnaire extension (note for planning)
</user_constraints>

## Summary

Phase 3 builds the `/gsd:profile-user` command that orchestrates the full profile activation flow: consent gate, session analysis (or questionnaire fallback), profile generation, result display, and artifact creation. This is primarily a workflow orchestration problem -- all the heavy lifting (session scanning, message sampling, profiling analysis, profile writing, questionnaire) is already implemented in Phase 1 and Phase 2. Phase 3 wires these existing subcommands into a cohesive user-facing experience with consent UX, progress feedback, result display, and artifact generation.

The key artifacts are: (1) `commands/gsd/profile-user.md` command definition with YAML frontmatter and argument handling, (2) `get-shit-done/workflows/profile-user.md` workflow with numbered steps orchestrating the full flow, (3) a `generate-dev-preferences` gsd-tools.js subcommand that produces the `/gsd:dev-preferences` command file from USER-PROFILE.md, (4) a `generate-claude-profile` gsd-tools.js subcommand that produces/updates a CLAUDE.md profile section, and (5) associated tests. The workflow spawns the `gsd-user-profiler` agent for session analysis and calls existing gsd-tools.js subcommands (`scan-sessions`, `profile-sample`, `write-profile`, `profile-questionnaire`) for the pipeline steps.

The ACTV-04 path decision in CONTEXT.md overrides REQUIREMENTS.md: the command file goes to `~/.claude/commands/gsd/dev-preferences.md` (GSD namespace), not `~/.claude/commands/dev-preferences.md` (top-level). This means the command is invoked as `/gsd:dev-preferences`, consistent with all other GSD commands.

**Primary recommendation:** Build the command definition and workflow as orchestration artifacts (markdown files) following existing GSD patterns exactly. Add two new gsd-tools.js subcommands (`generate-dev-preferences` and `generate-claude-profile`) for the artifact generation that needs deterministic file I/O. The consent flow, progress display, result card, and split resolution are all handled in the workflow via AskUserQuestion and formatted output -- no new infrastructure needed.

## Standard Stack

### Core
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Node.js `fs` | Built-in (v22.17.0) | Read/write profile artifacts, CLAUDE.md manipulation | Zero-dependency constraint |
| Node.js `path` | Built-in | Path resolution for `~/.claude/commands/gsd/` and profile paths | Zero-dependency constraint |
| Node.js `os` | Built-in | `os.homedir()` for `~/.claude/` resolution | Zero-dependency constraint |
| Existing `cmdProfileSample()` | Phase 2 | Session sampling with project-proportional caps | Already implemented |
| Existing `cmdWriteProfile()` | Phase 2 | Template rendering from analysis JSON to USER-PROFILE.md | Already implemented |
| Existing `cmdProfileQuestionnaire()` | Phase 2 | Question output and answer-to-analysis conversion | Already implemented |
| Existing `cmdScanSessions()` | Phase 1 | Session discovery for consent screen statistics | Already implemented |
| `gsd-user-profiler` agent | Phase 2 | LLM-based behavioral analysis across 8 dimensions | Already implemented |

### Supporting
| Library | Version | Purpose | When to Use |
|---------|---------|---------|-------------|
| AskUserQuestion | Claude Code built-in | Consent gate, artifact selection, split resolution | Workflow step interactions |
| Task (subagent spawn) | Claude Code built-in | Spawn gsd-user-profiler for session analysis | Analysis step |
| Existing `CLAUDE_INSTRUCTIONS` | Phase 2 | Map dimension/rating to imperative directives | dev-preferences generation |
| Existing `PROFILING_QUESTIONS` | Phase 2 | Questionnaire question definitions | Questionnaire fallback path |

### Alternatives Considered
| Instead of | Could Use | Tradeoff |
|------------|-----------|----------|
| Two new gsd-tools.js subcommands for artifact gen | Inline artifact generation in workflow | Subcommands are testable, deterministic, and follow established pattern; inline generation is harder to test |
| Workflow-based orchestration | Single monolithic gsd-tools.js command | Workflow enables AskUserQuestion, agent spawning, formatted output; gsd-tools.js cannot do interactive UX |
| Parallel agents for artifact generation | Sequential artifact generation | Sequential is simpler and fast enough (artifact generation is just file writes, < 1 second each); parallel adds complexity with no user-visible benefit |

**Installation:**
```bash
# No installation needed -- all built-in Node.js modules and existing Phase 1/2 infrastructure
```

## Architecture Patterns

### Recommended Project Structure
```
commands/gsd/
  profile-user.md              # NEW: /gsd:profile-user command definition
get-shit-done/
  bin/
    gsd-tools.js               # MODIFIED: +generate-dev-preferences, +generate-claude-profile subcommands
    gsd-tools.test.js           # MODIFIED: +tests for new subcommands
  workflows/
    profile-user.md            # NEW: Full orchestration workflow
  templates/
    dev-preferences.md         # NEW: Template for /gsd:dev-preferences command file
```

### Pattern 1: Command Definition with Flags
**What:** The `/gsd:profile-user` command definition follows the exact same YAML frontmatter pattern as existing GSD commands (e.g., `plan-phase.md`, `discuss-phase.md`).
**When to use:** All new GSD commands.
**Why verified:** Read 8 existing command definitions in `commands/gsd/`. Pattern is consistent: YAML frontmatter (name, description, argument-hint, allowed-tools), then `<objective>`, `<execution_context>`, `<context>`, `<process>` sections.

**Example command definition:**
```markdown
---
name: gsd:profile-user
description: Generate developer profile from session analysis and create Claude-discoverable artifacts
argument-hint: "[--questionnaire] [--refresh]"
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
  - Task
---

<objective>
Generate a developer behavioral profile and produce artifacts (USER-PROFILE.md,
/gsd:dev-preferences, CLAUDE.md section) that personalize Claude's responses.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/profile-user.md
@~/.claude/get-shit-done/references/ui-brand.md
</execution_context>

<context>
Flags: $ARGUMENTS
- `--questionnaire` — Skip session analysis, questionnaire-only
- `--refresh` — Rebuild profile even when one exists
</context>

<process>
Execute the profile-user workflow end-to-end.
</process>
```

### Pattern 2: Multi-Step Workflow Orchestration
**What:** The workflow follows the established numbered-step pattern from `plan-phase.md`, `discuss-phase.md`, `new-project.md`. Each step has a name, clear inputs/outputs, conditional branching, and error handling.
**When to use:** All multi-step GSD workflows.
**Why verified:** Read 5 existing workflow files. All follow: `<purpose>` header, `<process>` with numbered steps, bash calls to gsd-tools.js, AskUserQuestion for user interaction, agent spawning via Task, formatted output via ui-brand.md patterns.

**Workflow step outline:**
```
1. Initialize — Parse flags, check existing profile, detect mode
2. Consent Gate — Present value proposition, data handling, dimension list (ACTV-06)
3. Session Scan — Run scan-sessions, display statistics, determine data sufficiency
4. Analysis — Branch: session analysis (spawn profiler) OR questionnaire
5. Split Resolution — Present context-dependent splits for user resolution
6. Profile Write — Call write-profile with analysis JSON
7. Result Display — Show summary card with ratings, confidence, highlights
8. Artifact Selection — AskUserQuestion multiSelect for output artifacts
9. Artifact Generation — Generate selected artifacts (dev-preferences, CLAUDE.md)
10. Summary — Show paths to created artifacts, suggest next steps
```

### Pattern 3: gsd-tools.js Subcommand for Artifact Generation
**What:** Deterministic file I/O operations are implemented as gsd-tools.js subcommands (not in the workflow), following the established pattern from Phase 1 and Phase 2.
**When to use:** When artifact generation needs to be testable, deterministic, and callable from both workflows and tests.
**Why verified:** Phase 2 added `profile-sample`, `write-profile`, `profile-questionnaire` as subcommands. Each follows: function definition, CLI case dispatch, JSON output via `output()`. Tests use `runGsdTools()` helper with temp directories.

**Example subcommand pattern:**
```javascript
// Source: Existing gsd-tools.js subcommand pattern (verified Phase 2)
function cmdGenerateDevPreferences(cwd, options, raw) {
  // 1. Read USER-PROFILE.md (or analysis JSON)
  // 2. Extract dimension ratings and claude_instructions
  // 3. Read dev-preferences template
  // 4. Render template with profile data
  // 5. Write to ~/.claude/commands/gsd/dev-preferences.md
  // 6. Output result JSON
}
```

### Pattern 4: CLAUDE.md Profile Section Insert/Update
**What:** When CLAUDE.md exists, locate or create a `## Developer Profile` section with source comments (`<!-- GSD:profile-start -->` / `<!-- GSD:profile-end -->`). Replace content between markers. When CLAUDE.md does not exist, create a minimal CLAUDE.md with the profile section.
**When to use:** CLAUDE.md artifact generation.
**Why verified:** CONTEXT.md locks: "When CLAUDE.md already exists: add/update profile section only, leave everything else untouched." The marker pattern is standard for section-level updates in GSD (similar to `<!-- Source: ... -->` patterns planned in CLMD-03).

**Example CLAUDE.md section:**
```markdown
<!-- GSD:profile-start -->
## Developer Profile

> Generated by GSD from session analysis. Run `/gsd:profile-user --refresh` to update.

- **Communication:** Detailed-structured (HIGH) -- Use headers, numbered lists, acknowledge context
- **Decisions:** Deliberate-informed (MEDIUM) -- Present comparison tables with trade-offs
- **Explanations:** Concise (HIGH) -- Brief explanation with code, keep prose minimal
[... remaining dimensions ...]
<!-- GSD:profile-end -->
```

### Pattern 5: dev-preferences Command File Structure
**What:** A static `.md` file at `~/.claude/commands/gsd/dev-preferences.md` with YAML frontmatter and imperative directives. No argument handling -- it is a passive command that loads developer preferences into the current session when invoked.
**When to use:** Generating the `/gsd:dev-preferences` artifact.
**Why verified:** Read existing commands at `~/.claude/commands/gsd/`. Verified Claude Code command file format via Context7: commands use markdown with optional YAML frontmatter. A command without `argument-hint` and with prose body is loaded as instructions when invoked.

**Example dev-preferences output:**
```markdown
---
description: Load developer preferences into this session
---

# Developer Preferences

> Generated by GSD profile analysis. Run `/gsd:profile-user --refresh` to regenerate.

## Behavioral Directives

### Communication
Match this developer's structured communication: use headers for sections, numbered
lists for steps, and acknowledge provided context before responding. (HIGH confidence)

### Decision Support
Present options in a structured comparison table with pros/cons. Let the developer
make the final call. (MEDIUM confidence)

[... remaining 6 dimensions ...]

## Stack Preferences

- **Primary languages:** JavaScript, TypeScript
- **Frameworks:** React, Next.js, Node.js/Express
- **Database:** PostgreSQL with Prisma ORM
- **Testing:** Jest, Node.js built-in test runner
- **Build tools:** esbuild, npm scripts
[... inferred from session analysis or questionnaire ...]
```

### Anti-Patterns to Avoid
- **Duplicating Phase 2 logic in the workflow:** The workflow calls existing subcommands (`profile-sample`, `write-profile`, `profile-questionnaire`). Never reimplement sampling, template rendering, or questionnaire logic in the workflow or new subcommands.
- **Making the consent gate skippable via flag:** ACTV-06 requires explicit opt-in consent before reading JSONL files. The `--questionnaire` flag skips session analysis (no JSONL reading), so consent is not needed. But the default flow MUST show consent before any scan.
- **Hardcoding paths without `os.homedir()`:** All paths to `~/.claude/` must use `path.join(os.homedir(), '.claude', ...)` for cross-platform compatibility. Never hardcode `/Users/username/...`.
- **Generating dev-preferences inline in the workflow:** File generation must be in gsd-tools.js subcommands for testability. The workflow calls the subcommand and displays the result.
- **Overwriting entire CLAUDE.md:** When CLAUDE.md exists, only the profile section (between markers) is replaced. Everything else is preserved. This is a locked decision.

## Discretion Recommendations

These are areas where the CONTEXT.md gave Claude discretion. Here are researched recommendations.

### 1. Consent Screen Copy and Layout

**Recommendation:** Use a GSD stage banner followed by a structured consent block. Format:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GSD ► PROFILE YOUR CODING STYLE
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Claude starts every conversation generic. A profile teaches Claude
how YOU actually work — not how you think you work.

## What We'll Analyze

Your recent Claude Code sessions across [N] projects, looking for
patterns in these 8 dimensions:

| Dimension | What It Measures |
|-----------|-----------------|
| Communication Style | How you phrase requests (terse vs. detailed) |
| Decision Speed | How you choose between options |
| Explanation Depth | How much explanation you want with code |
| Debugging Approach | How you tackle errors and bugs |
| UX Philosophy | How much you care about design vs. function |
| Vendor Philosophy | How you evaluate libraries and tools |
| Frustration Triggers | What makes you correct Claude |
| Learning Style | How you prefer to learn new things |

## Data Handling

✓ Reads session files locally (read-only, nothing modified)
✓ Analyzes message patterns (not content meaning)
✓ Stores profile at ~/.claude/get-shit-done/USER-PROFILE.md
✗ Nothing is sent to external services
✗ Sensitive content (API keys, passwords) is automatically excluded
```

Then present AskUserQuestion: "Ready to analyze your sessions?" with options "Let's go" / "Use questionnaire instead" / "Not now".

**Rationale:** Matches ui-brand.md banner pattern. Lists all 8 dimensions so the user knows exactly what is being measured. Data handling section addresses privacy concerns proactively. Three options map cleanly to the three modes (session analysis, questionnaire, cancel).

### 2. Progress Indicator Implementation

**Recommendation:** Use sequential status lines on stderr (matching Phase 1 `process.stderr.write` pattern), displayed by the workflow between gsd-tools.js calls:

```
◆ Scanning sessions...         [after consent, before scan-sessions call]
✓ Found 319 sessions across 6 projects

◆ Sampling messages...          [before profile-sample call]
✓ Sampled 150 messages from 6 projects

◆ Analyzing patterns...         [before spawning profiler agent]
✓ Analysis complete (8 dimensions scored)

◆ Writing profile...            [before write-profile call]
✓ Profile written to ~/.claude/get-shit-done/USER-PROFILE.md
```

**Rationale:** Uses existing GSD status symbols (ui-brand.md: `◆` in progress, `✓` complete). Each line corresponds to a real workflow step, not fabricated progress. The workflow displays these between actual command calls.

### 3. Summary Card Format

**Recommendation:** Use a table format for the report card (matches GSD table conventions from ui-brand.md), followed by a highlight reel:

```
## Your Profile

| Dimension | Rating | Confidence |
|-----------|--------|------------|
| Communication | detailed-structured | HIGH |
| Decisions | deliberate-informed | MEDIUM |
| Explanations | concise | HIGH |
| Debugging | hypothesis-driven | MEDIUM |
| UX Philosophy | pragmatic | LOW |
| Vendor Choices | thorough-evaluator | HIGH |
| Frustrations | scope-creep | MEDIUM |
| Learning | self-directed | HIGH |

## Highlights

- **Communication (HIGH):** You consistently provide structured context with
  headers and problem statements before making requests
- **Vendor Choices (HIGH):** You research alternatives thoroughly -- comparing
  docs, GitHub activity, and bundle sizes before committing
- **Frustrations (MEDIUM):** You correct Claude most often for doing things
  you didn't ask for -- scope creep is your primary trigger
```

**Rationale:** Table gives the "report card at a glance" the user requested. Highlights pick the 3-4 most interesting findings (highest confidence + most evidence). The workflow reads the analysis JSON and formats this directly -- no template needed for display.

### 4. Backup File Naming Convention for --refresh

**Recommendation:** Use `USER-PROFILE.backup.md` (singular, no timestamp). On subsequent --refresh, overwrite the previous backup.

**Rationale:** Users want to compare "before" and "after", not maintain an archive of every profile version. A single backup is sufficient. If users want version history, git tracks it. The CONTEXT.md specifies "USER-PROFILE.backup.md" specifically.

### 5. Parallel vs Sequential Artifact Generation

**Recommendation:** Use sequential artifact generation, not parallel agents.

**Rationale:** Artifact generation is deterministic file I/O via gsd-tools.js subcommands. Each takes < 1 second. Spawning parallel agents adds complexity (agent coordination, error aggregation) with zero user-visible benefit. The workflow calls `generate-dev-preferences` then `generate-claude-profile` sequentially. The CONTEXT.md says "parallel agents" but also lists this as Claude's discretion. Sequential is clearly better here.

### 6. Stack Preferences Structure in dev-preferences

**Recommendation:** Structure as a categorized list under a `## Stack Preferences` heading:

```markdown
## Stack Preferences

Inferred from session analysis and project patterns.

- **Primary languages:** JavaScript, TypeScript
- **Frontend:** React, Next.js, Tailwind CSS
- **Backend:** Node.js, Express
- **Database:** PostgreSQL, Prisma ORM
- **Testing:** Jest, Node.js built-in test runner
- **Build/Deploy:** esbuild, npm scripts, Vercel
- **CLI patterns:** Commander.js (or vanilla Node.js)
```

Stack preferences are extracted from the `profile-sample` output by analyzing `projectName` values and the session content. The `generate-dev-preferences` subcommand reads the analysis JSON (which includes `projects_analyzed`) and optionally a separate stack analysis JSON if available. For questionnaire-only profiles, this section shows "Stack preferences not available (questionnaire-only profile)."

**Rationale:** Categorized list is scannable and easy for Claude to parse. The deferred ideas note says "Stack preference questions added to questionnaire -- requires Phase 2 questionnaire extension" which means questionnaire-only profiles will not have stack data yet. Session-based profiles can infer stack from project metadata and content patterns.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Session sampling | Custom sampling in workflow | `gsd-tools.js profile-sample` | Already implements project-proportional sampling, recency weighting, content truncation |
| Profile rendering | Custom markdown generation | `gsd-tools.js write-profile` | Already implements template rendering, sensitive content redaction, all 8 dimensions |
| Questionnaire | Custom question prompts | `gsd-tools.js profile-questionnaire` | Already implements dual-mode (interactive/answers), schema-compatible output, confidence capping |
| Behavioral analysis | Custom pattern matching | `gsd-user-profiler` agent | Already implements 8-dimension analysis with reference doc rubric, evidence curation |
| Session discovery | Custom directory scanning | `gsd-tools.js scan-sessions` | Already implements filesystem discovery, index enrichment, project metadata |
| Template placeholder rendering | Custom string replacement | Existing `{{placeholder}}` pattern from write-profile | Phase 2 already solved this with template file + regex replacement |
| YAML frontmatter for command files | Custom YAML generation | Static template with profile data inserted | Command file frontmatter is simple and fixed; no need for YAML generation |

**Key insight:** Phase 3 is almost entirely orchestration. The engine is built (Phase 1 + 2). This phase wires it into a user-facing workflow and produces the output artifacts. The only new "logic" is artifact generation (dev-preferences file and CLAUDE.md section), which are straightforward template-and-render operations.

## Common Pitfalls

### Pitfall 1: Consent Gate Bypass via --refresh
**What goes wrong:** The `--refresh` flag rebuilds the profile, which requires reading session data. If consent is not re-checked on refresh, users who previously opted in may not realize their data is being re-read.
**Why it happens:** Developers assume that prior consent carries forward.
**How to avoid:** On `--refresh`, skip the full consent screen but show a brief reminder: "Re-analyzing your sessions to update your profile. Press Enter to continue or type 'cancel'." This respects the locked decision (consent before JSONL reading) without being annoying on refresh.
**Warning signs:** Profile refreshes without any user confirmation step.

### Pitfall 2: Profile Exists Check Not Gating Properly
**What goes wrong:** Running `/gsd:profile-user` when a profile already exists silently overwrites it. User loses their existing profile.
**Why it happens:** Missing existence check at workflow start.
**How to avoid:** Step 1 of the workflow checks for `~/.claude/get-shit-done/USER-PROFILE.md`. If it exists AND `--refresh` is not set, present: "You already have a profile (generated [date]). Want to view it, refresh it, or cancel?" This is standard UX -- don't destroy existing work without confirmation.
**Warning signs:** Running profile-user twice produces a profile without asking about the existing one.

### Pitfall 3: Questionnaire Mode Still Shows Consent for Session Reading
**What goes wrong:** User runs `--questionnaire` flag to explicitly skip session analysis, but still sees the consent screen about reading JSONL files.
**Why it happens:** Consent flow is unconditional.
**How to avoid:** When `--questionnaire` flag is set, skip the consent gate entirely (no JSONL reading occurs). Go directly to the questionnaire. The consent gate is specifically for session analysis (ACTV-06: "Session analysis requires explicit opt-in consent before reading any JSONL files").
**Warning signs:** `--questionnaire` user sees irrelevant consent about session files.

### Pitfall 4: CLAUDE.md Marker Corruption
**What goes wrong:** CLAUDE.md has user content between the `<!-- GSD:profile-start -->` and `<!-- GSD:profile-end -->` markers (user manually edited profile section), and regeneration destroys their edits.
**Why it happens:** Marker-based replacement replaces everything between markers.
**How to avoid:** Before replacing, show a diff of what will change. If the existing content between markers differs from what was last generated (compare with a hash stored in the marker comment), warn the user: "The profile section in CLAUDE.md has been manually edited. Replace with regenerated content?" For Phase 3, a simpler approach is acceptable: always replace between markers, document that manual edits to the profile section will be overwritten on refresh. The deferred ideas note that Phase 4 handles CLAUDE.md management more comprehensively.
**Warning signs:** Users report losing their manual CLAUDE.md edits after profile refresh.

### Pitfall 5: dev-preferences Path Does Not Exist
**What goes wrong:** `generate-dev-preferences` tries to write to `~/.claude/commands/gsd/dev-preferences.md` but the `gsd/` subdirectory doesn't exist (GSD not installed, or commands directory structure is different).
**Why it happens:** The `gsd/` subdirectory under `commands/` is created by the GSD installer. If the user installed differently or the directory was cleaned, it may not exist.
**How to avoid:** Before writing, ensure the directory exists with `fs.mkdirSync(dir, { recursive: true })`. This is the same pattern used by `write-profile` for the `~/.claude/get-shit-done/` directory.
**Warning signs:** `ENOENT: no such file or directory` when generating dev-preferences.

### Pitfall 6: Analysis JSON Lifecycle (Temp File Cleanup)
**What goes wrong:** The profiler agent's analysis output is saved as a temp file (for passing to `write-profile`). If the workflow fails partway through, temp files accumulate.
**Why it happens:** Temp file cleanup only happens on success.
**How to avoid:** Write the analysis JSON to the same temp directory created by `profile-sample` (reuse the `gsd-profile-*` temp dir). On workflow completion (success or failure), clean up the entire temp directory. The workflow should track the temp dir path and include cleanup in both success and error paths.
**Warning signs:** `/tmp/gsd-profile-*` directories accumulating on disk.

### Pitfall 7: Split Resolution Creates Invalid Ratings
**What goes wrong:** When presenting context-dependent splits, the user's choice creates a rating value that doesn't exist in the dimension's rating spectrum (e.g., "context-dependent" as a literal rating value).
**Why it happens:** The split resolution step produces a user choice that needs to map back to the profile schema.
**How to avoid:** The split resolution step should offer the actual rating options plus "context-dependent" as a special case. If the user picks "context-dependent", keep the dominant rating in the `rating` field and add a `context_note` to the summary. The profile schema already supports `cross_project_consistent: false` with descriptive summaries. The `claude_instruction` should reference both patterns.
**Warning signs:** `rating` field contains "context-dependent" which is not in the valid rating spectrum.

### Pitfall 8: Stale Stack Preferences from Session Analysis
**What goes wrong:** Stack preferences show outdated technologies because they are inferred from all-time session history, including old projects.
**Why it happens:** `profile-sample` uses recency weighting for behavioral signals but stack inference may look at all projects equally.
**How to avoid:** When inferring stack preferences, weight recent projects (last 30 days) higher. If the user's most recent projects use different tech than older ones, the stack should reflect current usage. For Phase 3, a simple approach is acceptable: list technologies observed in the most recent projects, with a note "Based on your recent projects." Phase 8 (Integration) handles ongoing stack tracking more comprehensively.
**Warning signs:** Dev-preferences lists technologies the user hasn't used in months.

## Code Examples

Verified patterns from investigation of the existing codebase.

### generate-dev-preferences Subcommand
```javascript
// Source: Based on existing cmdWriteProfile pattern in gsd-tools.js
function cmdGenerateDevPreferences(cwd, options, raw) {
  // Read profile or analysis JSON
  let profilePath = options.profile || path.join(os.homedir(), '.claude', 'get-shit-done', 'USER-PROFILE.md');
  let analysisPath = options.analysis;

  // Need the analysis JSON for structured data
  if (!analysisPath) {
    error('--analysis <path-to-analysis-json> is required');
  }
  if (!path.isAbsolute(analysisPath)) {
    analysisPath = path.join(cwd, analysisPath);
  }
  if (!fs.existsSync(analysisPath)) {
    error(`Analysis file not found: ${analysisPath}`);
  }

  let analysis;
  try {
    analysis = JSON.parse(fs.readFileSync(analysisPath, 'utf-8'));
  } catch (err) {
    error(`Failed to parse analysis JSON: ${err.message}`);
  }

  // Read template
  const templatePath = path.join(__dirname, '..', 'templates', 'dev-preferences.md');
  if (!fs.existsSync(templatePath)) {
    error(`Template not found: ${templatePath}`);
  }
  let template = fs.readFileSync(templatePath, 'utf-8');

  // Render dimensions into template
  const DIMENSION_KEYS = [
    'communication_style', 'decision_speed', 'explanation_depth',
    'debugging_approach', 'ux_philosophy', 'vendor_philosophy',
    'frustration_triggers', 'learning_style'
  ];

  const dimensionLabels = {
    communication_style: 'Communication',
    decision_speed: 'Decision Support',
    explanation_depth: 'Explanations',
    debugging_approach: 'Debugging',
    ux_philosophy: 'UX Approach',
    vendor_philosophy: 'Library & Tool Choices',
    frustration_triggers: 'Boundaries',
    learning_style: 'Learning Support',
  };

  let directivesBlock = '';
  for (const dimKey of DIMENSION_KEYS) {
    const dim = analysis.dimensions?.[dimKey];
    if (!dim) continue;
    const label = dimensionLabels[dimKey] || dimKey;
    const instruction = dim.claude_instruction || generateClaudeInstruction(dimKey, dim.rating);
    const conf = dim.confidence || 'UNSCORED';
    directivesBlock += `### ${label}\n${instruction} (${conf} confidence)\n\n`;
  }

  template = template.replace('{{behavioral_directives}}', directivesBlock.trim());
  template = template.replace('{{generated_at}}', new Date().toISOString());
  template = template.replace('{{data_source}}', analysis.data_source || 'session_analysis');

  // Stack preferences (from projects_analyzed metadata)
  let stackBlock = '';
  if (analysis.data_source === 'questionnaire') {
    stackBlock = 'Stack preferences not available (questionnaire-only profile). Run `/gsd:profile-user --refresh` with session data to populate.';
  } else {
    // Placeholder for stack inference -- populated by workflow or future enhancement
    stackBlock = options.stack || 'Stack preferences will be populated from session analysis.';
  }
  template = template.replace('{{stack_preferences}}', stackBlock);

  // Output path
  const outputPath = options.output || path.join(os.homedir(), '.claude', 'commands', 'gsd', 'dev-preferences.md');
  fs.mkdirSync(path.dirname(outputPath), { recursive: true });
  fs.writeFileSync(outputPath, template, 'utf-8');

  output({
    command_path: outputPath,
    command_name: '/gsd:dev-preferences',
    dimensions_included: DIMENSION_KEYS.filter(k => analysis.dimensions?.[k]).length,
    source: analysis.data_source || 'session_analysis',
  }, raw);
}
```

### generate-claude-profile Subcommand
```javascript
// Source: Based on CONTEXT.md locked decision for CLAUDE.md section management
function cmdGenerateClaudeProfile(cwd, options, raw) {
  let analysisPath = options.analysis;
  if (!analysisPath) {
    error('--analysis <path-to-analysis-json> is required');
  }
  if (!path.isAbsolute(analysisPath)) {
    analysisPath = path.join(cwd, analysisPath);
  }

  let analysis;
  try {
    analysis = JSON.parse(fs.readFileSync(analysisPath, 'utf-8'));
  } catch (err) {
    error(`Failed to parse analysis JSON: ${err.message}`);
  }

  const DIMENSION_KEYS = [
    'communication_style', 'decision_speed', 'explanation_depth',
    'debugging_approach', 'ux_philosophy', 'vendor_philosophy',
    'frustration_triggers', 'learning_style'
  ];

  const dimensionLabels = {
    communication_style: 'Communication',
    decision_speed: 'Decisions',
    explanation_depth: 'Explanations',
    debugging_approach: 'Debugging',
    ux_philosophy: 'UX Philosophy',
    vendor_philosophy: 'Vendor Choices',
    frustration_triggers: 'Frustrations',
    learning_style: 'Learning',
  };

  // Build profile section content
  let sectionLines = [];
  sectionLines.push('<!-- GSD:profile-start -->');
  sectionLines.push('## Developer Profile');
  sectionLines.push('');
  sectionLines.push('> Generated by GSD from ' + (analysis.data_source || 'session analysis') +
    '. Run `/gsd:profile-user --refresh` to update.');
  sectionLines.push('');

  for (const dimKey of DIMENSION_KEYS) {
    const dim = analysis.dimensions?.[dimKey];
    if (!dim) continue;
    const label = dimensionLabels[dimKey] || dimKey;
    const rating = dim.rating || 'unscored';
    const conf = dim.confidence || 'UNSCORED';
    const instruction = dim.claude_instruction || '';
    sectionLines.push(`- **${label}:** ${rating} (${conf}) -- ${instruction}`);
  }

  sectionLines.push('<!-- GSD:profile-end -->');

  const sectionContent = sectionLines.join('\n');

  // Determine target CLAUDE.md path
  const targetPath = options.output || path.join(cwd, 'CLAUDE.md');
  const isGlobal = options.global === true;
  const globalPath = path.join(os.homedir(), '.claude', 'CLAUDE.md');
  const effectivePath = isGlobal ? globalPath : targetPath;

  let action;
  if (fs.existsSync(effectivePath)) {
    // Read existing and replace between markers (or append)
    let existing = fs.readFileSync(effectivePath, 'utf-8');
    const startMarker = '<!-- GSD:profile-start -->';
    const endMarker = '<!-- GSD:profile-end -->';
    const startIdx = existing.indexOf(startMarker);
    const endIdx = existing.indexOf(endMarker);

    if (startIdx !== -1 && endIdx !== -1) {
      // Replace between markers
      existing = existing.substring(0, startIdx) + sectionContent + existing.substring(endIdx + endMarker.length);
      action = 'updated';
    } else {
      // Append section
      existing = existing.trimEnd() + '\n\n' + sectionContent + '\n';
      action = 'appended';
    }
    fs.writeFileSync(effectivePath, existing, 'utf-8');
  } else {
    // Create new CLAUDE.md with just the profile section
    fs.mkdirSync(path.dirname(effectivePath), { recursive: true });
    fs.writeFileSync(effectivePath, sectionContent + '\n', 'utf-8');
    action = 'created';
  }

  output({
    claude_md_path: effectivePath,
    action,
    dimensions_included: DIMENSION_KEYS.filter(k => analysis.dimensions?.[k]).length,
    is_global: isGlobal,
  }, raw);
}
```

### Workflow Consent Gate Step
```markdown
## 2. Consent Gate (ACTV-06)

**Skip if:** `--questionnaire` flag is set (no session reading occurs).

Display consent screen using the ui-brand banner and dimension table.

Then use AskUserQuestion:
- header: "Ready?"
- question: "Ready to analyze your sessions?"
- options:
  - "Let's go" — Proceed to session analysis
  - "Use questionnaire instead" — Skip to questionnaire path
  - "Not now" — Exit workflow

**If "Let's go":** Continue to step 3 (session scan).
**If "Use questionnaire instead":** Jump to step 4b (questionnaire path).
**If "Not now":** Display "No worries. Run /gsd:profile-user when ready." and exit.
```

### Workflow Profile Exists Check
```markdown
## 1. Initialize

Parse flags from $ARGUMENTS: `--questionnaire`, `--refresh`.

Check for existing profile:
```bash
PROFILE_PATH="$HOME/.claude/get-shit-done/USER-PROFILE.md"
if [ -f "$PROFILE_PATH" ]; then
  PROFILE_EXISTS=true
  PROFILE_DATE=$(head -5 "$PROFILE_PATH" | grep "Generated:" | sed 's/.*Generated: //')
fi
```

**If profile exists AND --refresh NOT set:**
Use AskUserQuestion:
- header: "Existing Profile"
- question: "You already have a profile (generated [date]). What would you like to do?"
- options:
  - "View it" — Display summary card from existing profile, then exit
  - "Refresh it" — Continue with --refresh behavior
  - "Cancel" — Exit

**If profile exists AND --refresh IS set:**
Backup existing profile:
```bash
cp "$PROFILE_PATH" "${PROFILE_PATH%.md}.backup.md"
```
Show brief reminder: "Re-analyzing your sessions to update your profile."
Continue to consent gate.

**If no profile exists:** Continue to consent gate.
```

### dev-preferences Template
```markdown
---
description: Load developer preferences into this session
---

# Developer Preferences

> Generated by GSD on {{generated_at}} from {{data_source}}.
> Run `/gsd:profile-user --refresh` to regenerate.

## Behavioral Directives

Follow these directives when working with this developer. Higher confidence
directives should be applied directly. Lower confidence directives should be
tried with hedging ("Based on your profile, I'll try X -- let me know if
that's off").

{{behavioral_directives}}

## Stack Preferences

{{stack_preferences}}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Manual preferences configuration (JSON/YAML) | Learned behavioral profile from session analysis | 2025-2026 | Shifts from "configure" to "observe and learn" -- lower setup friction, higher accuracy |
| Single global instructions file | Per-dimension confidence scoring with hedging | 2025-2026 | LOW confidence directives are tried with caveats, not applied blindly |
| All-or-nothing profile generation | Multi-artifact output (profile, command, CLAUDE.md) | Current | Developer chooses which integration points to activate |

**Deprecated/outdated:**
- REQUIREMENTS.md specifies `~/.claude/commands/dev-preferences.md` (top-level). CONTEXT.md overrides to `~/.claude/commands/gsd/dev-preferences.md` (GSD namespace). The CONTEXT.md decision is authoritative.
- REQUIREMENTS.md success criterion #4 says "/dev-preferences command file". The actual command will be `/gsd:dev-preferences` due to the namespace override.

## Open Questions

1. **How should stack preferences be inferred from session data?**
   - What we know: The `profile-sample` output includes `projectName` for each message. The profiler agent sees project names. But neither currently extracts stack/tool information from message content.
   - What's unclear: Whether to add a stack inference step to the workflow (parse profile-sample content for framework/library mentions) or defer to Phase 8 Integration.
   - Recommendation: For Phase 3, implement basic stack inference in `generate-dev-preferences`: scan the analysis JSON's `projects_analyzed` list, and optionally accept a `--stack` flag with a comma-separated list that the workflow populates by reading the user's recent project package.json or similar. If neither is available, show "Stack preferences: run with session analysis to populate." This keeps Phase 3 scope manageable while not blocking the dev-preferences artifact. Full stack inference is a Phase 8 enhancement.

2. **How should the --refresh diff be displayed?**
   - What we know: CONTEXT.md specifies "shows compact diff of dimensions that changed rating/confidence."
   - What's unclear: The exact format for showing changes.
   - Recommendation: After regenerating, read both the old backup and the new profile. For each dimension, compare rating and confidence. Display a table showing only changed dimensions:
     ```
     ## Changes
     | Dimension | Before | After |
     |-----------|--------|-------|
     | Communication | terse-direct (LOW) | detailed-structured (HIGH) |
     | Debugging | fix-first (MEDIUM) | hypothesis-driven (MEDIUM) |
     ```
     If nothing changed: "No changes detected -- your profile is already up to date."
     Implementation: add a `diff-profiles` gsd-tools.js subcommand that reads two analysis JSONs and outputs the diff.

3. **Should the profiler agent be spawned directly or via a wrapper subcommand?**
   - What we know: The workflow needs to (1) call `profile-sample` to get a JSONL temp file, (2) spawn the profiler agent with that file as input, (3) extract the `<analysis>` JSON from the agent's output, (4) save the analysis JSON to a temp file for `write-profile`.
   - What's unclear: Whether steps 2-3 should be in the workflow (spawning the agent directly) or wrapped in a gsd-tools.js subcommand.
   - Recommendation: The workflow spawns the profiler agent directly using the Task tool (consistent with how plan-phase spawns gsd-phase-researcher). The agent output is parsed in the workflow. Wrapping agent spawning in gsd-tools.js would fight the Claude Code agent model. The analysis JSON is saved to a temp file by the workflow for downstream consumption.

## Sources

### Primary (HIGH confidence)
- **Existing gsd-tools.js implementation** - Read Phase 1 and Phase 2 subcommands (`cmdScanSessions`, `cmdProfileSample`, `cmdWriteProfile`, `cmdProfileQuestionnaire`, `CLAUDE_INSTRUCTIONS`, `PROFILING_QUESTIONS`). Verified function signatures, output schemas, and patterns.
- **Existing command definitions** - Read 8 command files at `commands/gsd/` (discuss-phase.md, plan-phase.md, set-profile.md, etc.). Verified YAML frontmatter format, execution_context references, allowed-tools patterns.
- **Existing workflow files** - Read 4 workflow files (discuss-phase.md, plan-phase.md, new-project.md, set-profile.md). Verified step numbering, AskUserQuestion usage, gsd-tools.js invocation patterns, agent spawning patterns.
- **Phase 2 verification report** - Confirmed all Phase 2 artifacts are complete: profiler agent, reference doc, profile-sample, write-profile, profile-questionnaire, CLAUDE_INSTRUCTIONS, 104 tests passing.
- **Claude Code command file format** - Context7 `/anthropics/claude-code`: Verified command file structure (YAML frontmatter + markdown body), namespaced directory structure (`commands/gsd/` for `/gsd:command-name`), `@` file reference syntax, `$ARGUMENTS` variable.
- **Claude Code AskUserQuestion** - Context7 `/anthropics/claude-code`: Verified `multiSelect: true` parameter, option format (label + description), multiple questions in sequence.
- **ui-brand.md reference** - Read `get-shit-done/references/ui-brand.md`. Verified banner format (`GSD ► STAGE`), status symbols (`✓`, `◆`, `✗`), table format, Next Up block pattern.

### Secondary (MEDIUM confidence)
- **CLAUDE.md section management** - No existing GSD implementation to verify against. The marker-based pattern (`<!-- GSD:profile-start -->` / `<!-- GSD:profile-end -->`) is a standard pattern for section replacement in markdown files. Verified in principle but not against an existing GSD CLAUDE.md workflow.
- **Stack inference from session data** - Based on analysis of what data is available (project names, message content). No existing implementation to verify. The recommendation to defer full stack inference is a conservative approach.

### Tertiary (LOW confidence)
- **Global CLAUDE.md location** - Assumed to be `~/.claude/CLAUDE.md` based on Claude Code convention. Not verified with official documentation for whether Claude Code reads this file automatically. If it doesn't, the "global CLAUDE.md" artifact option should be noted as potentially requiring manual setup.

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH - All reuses existing Phase 1/2 infrastructure plus standard GSD patterns
- Architecture: HIGH - Follows verified GSD command/workflow/subcommand patterns exactly
- Consent UX: HIGH - AskUserQuestion pattern verified via Context7 and existing GSD workflows
- Artifact generation: HIGH - dev-preferences is a simple template render; CLAUDE.md section is marker-based text replacement
- Stack inference: LOW - No existing implementation; basic approach recommended, full solution deferred
- Split resolution: MEDIUM - UX pattern clear but not yet validated with real profile data containing splits

**Research date:** 2026-02-14
**Valid until:** 2026-03-16 (stable -- orchestration patterns don't change; Claude Code command format is stable)
