---
phase: 03-profile-activation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - commands/gsd/profile-user.md
  - get-shit-done/workflows/profile-user.md
autonomous: true

must_haves:
  truths:
    - "/gsd:profile-user command is discoverable and invokable in Claude Code"
    - "Workflow orchestrates consent gate, session analysis, profile generation, result display, and artifact selection in sequence"
    - "--questionnaire flag skips session analysis and consent, going directly to questionnaire path"
    - "--refresh flag backs up existing profile, regenerates fresh, and shows dimension diff"
    - "Consent screen shows value proposition, 8 dimensions, and data handling details before any session reading"
    - "Profile result displays report card table with ratings/confidence and highlight reel with evidence quotes"
    - "Artifact selection presents multiSelect with all artifacts pre-selected by default"
  artifacts:
    - path: "commands/gsd/profile-user.md"
      provides: "Command definition for /gsd:profile-user with --questionnaire and --refresh flags"
      contains: "gsd:profile-user"
    - path: "get-shit-done/workflows/profile-user.md"
      provides: "10-step orchestration workflow for full profile activation flow"
      contains: "Consent Gate"
  key_links:
    - from: "commands/gsd/profile-user.md"
      to: "get-shit-done/workflows/profile-user.md"
      via: "execution_context @reference"
      pattern: "@~/.claude/get-shit-done/workflows/profile-user.md"
    - from: "get-shit-done/workflows/profile-user.md"
      to: "get-shit-done/bin/gsd-tools.js"
      via: "bash calls to scan-sessions, profile-sample, write-profile, profile-questionnaire, generate-dev-preferences, generate-claude-profile"
      pattern: "gsd-tools.js (scan-sessions|profile-sample|write-profile|profile-questionnaire|generate-dev-preferences|generate-claude-profile)"
---

<objective>
Create the `/gsd:profile-user` command definition and its orchestration workflow that walks the developer through consent, session analysis (or questionnaire fallback), profile generation, result display, and artifact creation.

Purpose: This is the user-facing entry point for the entire profiling system. It wires Phase 1 (session pipeline) and Phase 2 (profiling engine) into a cohesive experience.
Output: Command definition at `commands/gsd/profile-user.md` and workflow at `get-shit-done/workflows/profile-user.md`
</objective>

<execution_context>
@/Users/canodevelopment/.claude/get-shit-done/workflows/execute-plan.md
@/Users/canodevelopment/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-profile-activation/03-CONTEXT.md
@.planning/phases/03-profile-activation/03-RESEARCH.md

# Pattern references (read for format, not content)
@commands/gsd/discuss-phase.md
@commands/gsd/set-profile.md
@get-shit-done/workflows/discuss-phase.md
@get-shit-done/workflows/set-profile.md
@get-shit-done/references/ui-brand.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /gsd:profile-user command definition</name>
  <files>commands/gsd/profile-user.md</files>
  <action>
Create `commands/gsd/profile-user.md` following the exact YAML frontmatter pattern from existing GSD commands (discuss-phase.md, set-profile.md).

**Frontmatter:**
```yaml
name: gsd:profile-user
description: Generate developer behavioral profile and create Claude-discoverable artifacts
argument-hint: "[--questionnaire] [--refresh]"
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - AskUserQuestion
  - Task
```

**Sections:**
- `<objective>`: Generate a developer behavioral profile from session analysis (or questionnaire) and produce artifacts (USER-PROFILE.md, /gsd:dev-preferences, CLAUDE.md section) that personalize Claude's responses.
- `<execution_context>`: Reference the profile-user workflow and ui-brand.md
- `<context>`: Document the two flags: `--questionnaire` (skip session analysis, questionnaire-only) and `--refresh` (rebuild profile even when one exists). Note that flags come from $ARGUMENTS.
- `<process>`: "Execute the profile-user workflow end-to-end." Keep it minimal -- the workflow has all logic.

Follow the exact same structural pattern as `commands/gsd/discuss-phase.md`. The command definition is a thin routing layer.
  </action>
  <verify>
File exists at `commands/gsd/profile-user.md`. Contains YAML frontmatter with `name: gsd:profile-user`. Contains `<objective>`, `<execution_context>`, `<context>`, `<process>` sections. References the workflow file in execution_context.
  </verify>
  <done>
`/gsd:profile-user` command definition exists with proper frontmatter, flag documentation, and workflow reference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create profile-user orchestration workflow</name>
  <files>get-shit-done/workflows/profile-user.md</files>
  <action>
Create `get-shit-done/workflows/profile-user.md` following the established numbered-step workflow pattern from existing workflows (discuss-phase.md, new-project.md, set-profile.md).

**Structure:** `<purpose>`, `<required_reading>`, `<process>` with numbered `<step>` elements, `<success_criteria>`.

**10 workflow steps:**

**Step 1: Initialize**
- Parse flags from $ARGUMENTS: detect `--questionnaire` and `--refresh`
- Check for existing profile at `~/.claude/get-shit-done/USER-PROFILE.md`
- If profile exists AND --refresh NOT set: AskUserQuestion with options "View it" / "Refresh it" / "Cancel"
  - "View it": Display summary card from existing profile data, then exit
  - "Refresh it": Continue with --refresh behavior
  - "Cancel": Exit
- If profile exists AND --refresh IS set: Backup to USER-PROFILE.backup.md, show brief reminder "Re-analyzing your sessions to update your profile"
- If no profile: Continue to next step

**Step 2: Consent Gate (ACTV-06)**
- **Skip if** `--questionnaire` flag is set (no JSONL reading occurs)
- Display consent screen using ui-brand.md banner pattern:
  - GSD banner: `GSD > PROFILE YOUR CODING STYLE`
  - Value proposition: Claude starts generic; a profile teaches Claude how YOU actually work
  - Table of 8 behavioral dimensions being analyzed (Communication Style, Decision Speed, Explanation Depth, Debugging Approach, UX Philosophy, Vendor Philosophy, Frustration Triggers, Learning Style)
  - Data handling section with checkmarks/crosses: reads locally, stores profile, nothing sent externally, sensitive content excluded
- AskUserQuestion: "Ready to analyze your sessions?" with options:
  - "Let's go" -> Continue to step 3
  - "Use questionnaire instead" -> Jump to step 4b (questionnaire path)
  - "Not now" -> Display "No worries. Run /gsd:profile-user when ready." and exit
- On --refresh path: Show abbreviated consent: "Re-analyzing your sessions to update your profile. Continue?" with "Continue" / "Cancel"

**Step 3: Session Scan**
- Run `gsd-tools.js scan-sessions --json` to discover available sessions
- Display statistics: "Found N sessions across M projects"
- Determine data sufficiency:
  - Count total messages available (sum across projects)
  - If 0 sessions found: Switch to questionnaire-only (jump to step 4b)
  - If sessions found: Continue to step 4a

**Step 4a: Session Analysis Path**
- Run `gsd-tools.js profile-sample` to create sampled JSONL in temp directory
- Display progress: "Sampled N messages from M projects"
- Spawn `gsd-user-profiler` agent using Task tool with the sample JSONL as input
- Display progress: "Analyzing patterns..."
- Parse the `<analysis>` JSON from the agent's output
- Save analysis JSON to a temp file
- Display progress: "Analysis complete (N dimensions scored)"
- Check for thin data (< 50 messages): If thin, note that questionnaire supplement will be presented
- Continue to step 5

**Step 4b: Questionnaire Path**
- Display: "Using questionnaire to build your profile"
- Run `gsd-tools.js profile-questionnaire` (interactive mode) to get questions JSON
- Present each question to user via AskUserQuestion (8 questions, one per dimension)
- Collect answers JSON
- Run `gsd-tools.js profile-questionnaire --answers <answers-json-path>` to get analysis JSON
- Save analysis JSON to temp file
- Continue to step 5 (skip split resolution since questionnaire handles ambiguity internally)

**Step 5: Split Resolution**
- **Skip if** questionnaire-only path (splits already handled)
- Read analysis JSON and check each dimension for `cross_project_consistent: false`
- For each split detected, present AskUserQuestion:
  - Header: dimension name
  - Show the split with context: "Your sessions show different patterns: [context A] -> [rating A], [context B] -> [rating B]"
  - Options: rating A, rating B, "Context-dependent (keep both)"
  - If user picks a specific rating: Update the dimension's rating in analysis JSON
  - If user picks "Context-dependent": Keep the dominant rating, add context_note to summary
- Write updated analysis JSON back to temp file

**Step 6: Profile Write**
- Run `gsd-tools.js write-profile --input <analysis-json-path>`
- Display: "Profile written to ~/.claude/get-shit-done/USER-PROFILE.md"

**Step 7: Result Display**
- Read the analysis JSON to build display
- Show report card table: | Dimension | Rating | Confidence | (all 8 rows)
- Show highlight reel: Pick 3-4 dimensions with highest confidence and most evidence signals, format as "You tend to..." with evidence quotes
- AskUserQuestion: "Want to see the full profile?" with "Yes" / "Continue to artifacts"
  - "Yes": Display full USER-PROFILE.md content, then continue
  - "Continue to artifacts": Proceed to step 8

**Step 8: Artifact Selection (ACTV-05)**
- Present AskUserQuestion with multiSelect: "Which artifacts should I generate?"
- Options (ALL pre-selected by default):
  - "/gsd:dev-preferences command file" -- "Load your preferences in any session"
  - "CLAUDE.md profile section" -- "Add profile to this project's CLAUDE.md"
  - "Global CLAUDE.md" -- "Add profile to ~/.claude/CLAUDE.md for all projects"
- If no artifacts selected: Show "No artifacts generated. Your profile is saved at ~/.claude/get-shit-done/USER-PROFILE.md" and exit

**Step 9: Artifact Generation**
- Generate selected artifacts sequentially (per research recommendation -- file I/O is fast, no benefit from parallel agents):
- For dev-preferences: Run `gsd-tools.js generate-dev-preferences --analysis <path>`
- For CLAUDE.md section: Run `gsd-tools.js generate-claude-profile --analysis <path>`
- For global CLAUDE.md: Run `gsd-tools.js generate-claude-profile --analysis <path> --global`
- Display status line for each: "Generated /gsd:dev-preferences at ~/.claude/commands/gsd/dev-preferences.md"

**Step 10: Summary & Refresh Diff**
- If --refresh: Read both old backup and new analysis, compare dimension ratings/confidence. Display diff table showing only changed dimensions:
  ```
  | Dimension | Before | After |
  |-----------|--------|-------|
  | Communication | terse-direct (LOW) | detailed-structured (HIGH) |
  ```
  If nothing changed: "No changes detected -- your profile is already up to date."
- Display final summary with all artifact paths
- Clean up temp files (analysis JSON, sample JSONL temp dir)
- No "test it out" step per locked decision -- just summarize and done

**Important implementation notes:**
- All gsd-tools.js calls use `node ~/.claude/get-shit-done/bin/gsd-tools.js` prefix
- Progress indicators use `display` output (not stderr) since this is a workflow, not a CLI tool
- The workflow uses AskUserQuestion for all user interactions (consent, split resolution, artifact selection)
- Error handling: If any gsd-tools.js call fails, display the error and offer to retry or cancel
- The profiler agent is spawned via Task tool following the same pattern as plan-phase spawns gsd-phase-researcher
  </action>
  <verify>
File exists at `get-shit-done/workflows/profile-user.md`. Contains `<purpose>`, `<required_reading>`, `<process>` with 10 numbered steps. References gsd-tools.js subcommands: scan-sessions, profile-sample, write-profile, profile-questionnaire, generate-dev-preferences, generate-claude-profile. Contains consent gate with AskUserQuestion. Contains artifact selection with multiSelect. Contains --questionnaire and --refresh branching.
  </verify>
  <done>
Workflow orchestrates the complete profile activation flow: initialization with existing-profile check, consent gate (ACTV-06), session scan, analysis/questionnaire branching (ACTV-01/02), split resolution, profile writing, result display with report card, artifact selection (ACTV-05), sequential artifact generation, summary with refresh diff (ACTV-03).
  </done>
</task>

</tasks>

<verification>
- [ ] `commands/gsd/profile-user.md` exists with valid YAML frontmatter
- [ ] `get-shit-done/workflows/profile-user.md` exists with complete 10-step process
- [ ] Command definition references workflow via execution_context
- [ ] Workflow handles all three modes: default, --questionnaire, --refresh
- [ ] Consent gate only shown for session analysis path (not questionnaire)
- [ ] Artifact selection uses multiSelect with all options pre-selected
- [ ] Sequential artifact generation (not parallel agents)
- [ ] No deferred features implemented (auto-loading, auto-populate, brief assembly, stack questions)
</verification>

<success_criteria>
- /gsd:profile-user command definition follows established GSD command pattern
- Workflow covers all ACTV requirements: ACTV-01 (full flow), ACTV-02 (questionnaire), ACTV-03 (refresh), ACTV-05 (artifact selection), ACTV-06 (consent)
- All locked decisions from CONTEXT.md are implemented in the workflow steps
</success_criteria>

<output>
After completion, create `.planning/phases/03-profile-activation/03-01-SUMMARY.md`
</output>
