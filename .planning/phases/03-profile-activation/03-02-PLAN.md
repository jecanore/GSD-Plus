---
phase: 03-profile-activation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/templates/dev-preferences.md
autonomous: true

must_haves:
  truths:
    - "Running generate-dev-preferences produces a valid /gsd:dev-preferences command file from analysis JSON"
    - "Running generate-claude-profile creates or updates a CLAUDE.md with a profile section between markers"
    - "dev-preferences file is written to ~/.claude/commands/gsd/dev-preferences.md (GSD namespace per ACTV-04)"
    - "When CLAUDE.md already exists, only the profile section between markers is replaced"
    - "When CLAUDE.md does not exist, a new file is created with just the profile section"
    - "Both subcommands output JSON with path, action, and dimensions_included"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "generate-dev-preferences and generate-claude-profile subcommands"
      contains: "cmdGenerateDevPreferences"
    - path: "get-shit-done/templates/dev-preferences.md"
      provides: "Template for /gsd:dev-preferences command file with {{placeholder}} markers"
      contains: "{{behavioral_directives}}"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js (generate-dev-preferences)"
      to: "get-shit-done/templates/dev-preferences.md"
      via: "fs.readFileSync template path"
      pattern: "templates.*dev-preferences"
    - from: "get-shit-done/bin/gsd-tools.js (generate-dev-preferences)"
      to: "CLAUDE_INSTRUCTIONS"
      via: "fallback lookup for claude_instruction"
      pattern: "CLAUDE_INSTRUCTIONS"
    - from: "get-shit-done/bin/gsd-tools.js (generate-claude-profile)"
      to: "CLAUDE.md"
      via: "marker-based section insert/update"
      pattern: "GSD:profile-start.*GSD:profile-end"
---

<objective>
Implement two new gsd-tools.js subcommands for artifact generation: `generate-dev-preferences` (produces the /gsd:dev-preferences command file) and `generate-claude-profile` (produces/updates CLAUDE.md profile section). Also create the dev-preferences template.

Purpose: These subcommands provide the deterministic, testable file I/O that the profile-user workflow calls in step 9 (Artifact Generation). They transform analysis JSON into Claude-discoverable artifacts.
Output: Two new subcommands in gsd-tools.js, one template file
</objective>

<execution_context>
@/Users/canodevelopment/.claude/get-shit-done/workflows/execute-plan.md
@/Users/canodevelopment/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-profile-activation/03-CONTEXT.md
@.planning/phases/03-profile-activation/03-RESEARCH.md

# Implementation references
@get-shit-done/bin/gsd-tools.js
@get-shit-done/templates/user-profile.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dev-preferences template and generate-dev-preferences subcommand</name>
  <files>
    get-shit-done/templates/dev-preferences.md
    get-shit-done/bin/gsd-tools.js
  </files>
  <action>
**Part A: Create the dev-preferences template file.**

Create `get-shit-done/templates/dev-preferences.md` with this structure:

```markdown
---
description: Load developer preferences into this session
---

# Developer Preferences

> Generated by GSD on {{generated_at}} from {{data_source}}.
> Run `/gsd:profile-user --refresh` to regenerate.

## Behavioral Directives

Follow these directives when working with this developer. Higher confidence
directives should be applied directly. Lower confidence directives should be
tried with hedging ("Based on your profile, I'll try X -- let me know if
that's off").

{{behavioral_directives}}

## Stack Preferences

{{stack_preferences}}
```

Placeholders: `{{generated_at}}`, `{{data_source}}`, `{{behavioral_directives}}`, `{{stack_preferences}}`.

**Part B: Implement `cmdGenerateDevPreferences` function in gsd-tools.js.**

Add the function in the "Profiling Commands" section (after `cmdProfileQuestionnaire`).

**Function signature:** `function cmdGenerateDevPreferences(cwd, options, raw)`

**Required option:** `--analysis <path>` (path to analysis JSON file)
**Optional options:**
- `--output <path>` (override output path; default: `~/.claude/commands/gsd/dev-preferences.md`)
- `--stack <text>` (stack preferences text; if omitted and session-based, show placeholder note)

**Implementation:**
1. Validate and read analysis JSON (same pattern as `cmdWriteProfile` -- resolve path, check exists, parse)
2. Validate `analysis.dimensions` exists
3. Read the dev-preferences template from `path.join(__dirname, '..', 'templates', 'dev-preferences.md')`
4. Build behavioral directives block: For each of the 8 DIMENSION_KEYS:
   - Get `analysis.dimensions[dimKey]`
   - Use dimension label from lookup map (Communication, Decision Support, Explanations, Debugging, UX Approach, Library & Tool Choices, Boundaries, Learning Support)
   - Use `dim.claude_instruction` if present; else fall back to `CLAUDE_INSTRUCTIONS[dimKey]?.[dim.rating]` (the existing Phase 2 lookup)
   - Format: `### {Label}\n{instruction} ({confidence} confidence)\n\n`
5. Replace `{{behavioral_directives}}` with the built directives block (trimmed)
6. Replace `{{generated_at}}` with `new Date().toISOString()`
7. Replace `{{data_source}}` with `analysis.data_source || 'session_analysis'`
8. Build stack preferences:
   - If `analysis.data_source === 'questionnaire'`: "Stack preferences not available (questionnaire-only profile). Run `/gsd:profile-user --refresh` with session data to populate."
   - Else if `options.stack` provided: Use the provided stack text
   - Else: "Stack preferences will be populated from session analysis."
9. Replace `{{stack_preferences}}` with the stack block
10. Determine output path: `options.output || path.join(os.homedir(), '.claude', 'commands', 'gsd', 'dev-preferences.md')`
11. Ensure parent directory exists: `fs.mkdirSync(path.dirname(outputPath), { recursive: true })`
12. Write rendered template to output path
13. Output JSON: `{ command_path, command_name: '/gsd:dev-preferences', dimensions_included, source }`

**CLI dispatch:** Add `case 'generate-dev-preferences':` in the main switch. Parse `--analysis`, `--output`, `--stack` flags from args. Call `cmdGenerateDevPreferences(cwd, { analysis, output, stack }, raw)`.

**Dimension labels for dev-preferences (different from write-profile labels -- these are action-oriented):**
```javascript
const devPrefLabels = {
  communication_style: 'Communication',
  decision_speed: 'Decision Support',
  explanation_depth: 'Explanations',
  debugging_approach: 'Debugging',
  ux_philosophy: 'UX Approach',
  vendor_philosophy: 'Library & Tool Choices',
  frustration_triggers: 'Boundaries',
  learning_style: 'Learning Support',
};
```
  </action>
  <verify>
1. Template exists at `get-shit-done/templates/dev-preferences.md` and contains all 4 placeholders
2. `node get-shit-done/bin/gsd-tools.js generate-dev-preferences --analysis <test-json> --output /tmp/test-dev-prefs.md` produces a valid markdown file
3. Output file contains YAML frontmatter with `description:`, behavioral directive sections, and stack preferences
4. JSON output includes `command_path`, `command_name`, `dimensions_included`
  </verify>
  <done>
`generate-dev-preferences` subcommand reads analysis JSON, renders dev-preferences template with behavioral directives from CLAUDE_INSTRUCTIONS, writes to `~/.claude/commands/gsd/dev-preferences.md` (ACTV-04 path), and outputs result JSON.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement generate-claude-profile subcommand</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
**Implement `cmdGenerateClaudeProfile` function in gsd-tools.js.**

Add the function right after `cmdGenerateDevPreferences` in the "Profiling Commands" section.

**Function signature:** `function cmdGenerateClaudeProfile(cwd, options, raw)`

**Required option:** `--analysis <path>` (path to analysis JSON file)
**Optional options:**
- `--output <path>` (override CLAUDE.md path; default: `path.join(cwd, 'CLAUDE.md')`)
- `--global` flag (write to `~/.claude/CLAUDE.md` instead of cwd)

**Implementation:**
1. Validate and read analysis JSON (same pattern as other subcommands)
2. Build profile section content with markers:
   ```
   <!-- GSD:profile-start -->
   ## Developer Profile

   > Generated by GSD from {data_source}. Run `/gsd:profile-user --refresh` to update.

   | Dimension | Rating | Confidence |
   |-----------|--------|------------|
   | Communication | {rating} | {confidence} |
   [... all 8 dimensions ...]

   **Directives:**
   - **Communication:** {claude_instruction}
   [... all 8 dimension directives ...]
   <!-- GSD:profile-end -->
   ```
3. Use dimension labels matching the write-profile convention:
   ```javascript
   const profileLabels = {
     communication_style: 'Communication',
     decision_speed: 'Decisions',
     explanation_depth: 'Explanations',
     debugging_approach: 'Debugging',
     ux_philosophy: 'UX Philosophy',
     vendor_philosophy: 'Vendor Choices',
     frustration_triggers: 'Frustrations',
     learning_style: 'Learning',
   };
   ```
4. Determine target path: If `--global`, use `path.join(os.homedir(), '.claude', 'CLAUDE.md')`. Otherwise use `options.output || path.join(cwd, 'CLAUDE.md')`.
5. **If target file exists:** Read existing content.
   - Look for `<!-- GSD:profile-start -->` and `<!-- GSD:profile-end -->` markers
   - If both markers found: Replace everything from start marker to end marker (inclusive) with new section content. Set `action = 'updated'`.
   - If markers not found: Append the section at the end (with two newlines before). Set `action = 'appended'`.
   - Write updated content back.
6. **If target file does not exist:**
   - Ensure parent directory exists with `fs.mkdirSync(dir, { recursive: true })`
   - Write just the profile section content as the file
   - Set `action = 'created'`
7. Output JSON: `{ claude_md_path, action, dimensions_included, is_global }`

**CRITICAL locked decision:** When CLAUDE.md already exists, ONLY the profile section is replaced. Everything else is preserved untouched.

**CLI dispatch:** Add `case 'generate-claude-profile':` in the main switch. Parse `--analysis`, `--output`, `--global` flags from args. Call `cmdGenerateClaudeProfile(cwd, { analysis, output, global: hasGlobalFlag }, raw)`.
  </action>
  <verify>
1. `node get-shit-done/bin/gsd-tools.js generate-claude-profile --analysis <test-json> --output /tmp/test-CLAUDE.md` creates a new CLAUDE.md with profile section
2. Running the same command again with the existing file updates only between markers
3. Running against a CLAUDE.md that has other content preserves that content
4. `--global` flag changes the target path to `~/.claude/CLAUDE.md`
5. JSON output includes `claude_md_path`, `action` (created/updated/appended), `dimensions_included`, `is_global`
  </verify>
  <done>
`generate-claude-profile` subcommand reads analysis JSON, builds a marker-bounded profile section, and creates/updates CLAUDE.md with section management (create new, replace between markers, or append if no markers). Supports both project-local and global CLAUDE.md via --global flag.
  </done>
</task>

</tasks>

<verification>
- [ ] `get-shit-done/templates/dev-preferences.md` exists with {{placeholder}} markers
- [ ] `generate-dev-preferences` subcommand callable via CLI
- [ ] `generate-claude-profile` subcommand callable via CLI
- [ ] dev-preferences output path is `~/.claude/commands/gsd/dev-preferences.md` (not top-level)
- [ ] CLAUDE.md marker-based update preserves existing content
- [ ] Both subcommands handle missing analysis JSON gracefully (error message)
- [ ] Both use `os.homedir()` for ~ resolution (no hardcoded paths)
- [ ] Existing tests still pass (`node --test get-shit-done/bin/gsd-tools.test.js`)
</verification>

<success_criteria>
- Both subcommands follow the established gsd-tools.js pattern (function + CLI dispatch + JSON output)
- dev-preferences writes to GSD namespace path per ACTV-04 locked decision
- CLAUDE.md section management preserves existing content per locked decision
- Template uses {{placeholder}} pattern consistent with Phase 2 conventions
</success_criteria>

<output>
After completion, create `.planning/phases/03-profile-activation/03-02-SUMMARY.md`
</output>
