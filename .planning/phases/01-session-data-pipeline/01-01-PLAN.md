---
phase: 01-session-data-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/gsd-tools.js
autonomous: true

must_haves:
  truths:
    - "Running `gsd-tools.js scan-sessions` returns a table of all Claude Code projects with session count, total size, date range, and last active timestamp"
    - "Running `gsd-tools.js scan-sessions --json` returns the same data in machine-readable JSON format"
    - "When sessions-index.json is missing, scan-sessions discovers sessions via directory scan and notifies the user"
    - "When sessions-index.json exists, scan-sessions enriches metadata with index data (summary, messageCount, created)"
    - "Running `gsd-tools.js scan-sessions --verbose` lists individual sessions per project"
    - "loadConfig() returns `preferences` and `profile` keys with backward-compatible defaults"
    - "Friendly error displayed when no Claude Code sessions directory exists"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "Session discovery helpers, scan-sessions command, loadConfig extension"
      contains: "cmdScanSessions"
  key_links:
    - from: "main() switch"
      to: "cmdScanSessions()"
      via: "case 'scan-sessions' dispatch"
      pattern: "case 'scan-sessions'"
    - from: "cmdScanSessions()"
      to: "getSessionsDir()"
      via: "function call for sessions path resolution"
      pattern: "getSessionsDir"
    - from: "cmdScanSessions()"
      to: "scanProjectDir()"
      via: "function call for JSONL file discovery"
      pattern: "scanProjectDir"
    - from: "loadConfig()"
      to: "preferences/profile defaults"
      via: "get() with fallback to defaults object"
      pattern: "preferences.*profile"
---

<objective>
Build session discovery infrastructure and the `scan-sessions` command in gsd-tools.js.

Purpose: Provide the foundation for all session data pipeline operations. The helper functions created here (session directory resolution, project scanning, index reading, table formatting) are reused by both `scan-sessions` and `extract-messages`. The `scan-sessions` command is the developer's first interaction with the pipeline -- it shows what session data exists before any extraction happens.

Output: `gsd-tools.js` extended with helper functions, `scan-sessions` command, and `loadConfig()` extension for `preferences` and `profile` keys.
</objective>

<execution_context>
@/Users/canodevelopment/.claude/get-shit-done/workflows/execute-plan.md
@/Users/canodevelopment/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-session-data-pipeline/01-RESEARCH.md
@.planning/phases/01-session-data-pipeline/01-CONTEXT.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
@get-shit-done/bin/gsd-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session discovery helper functions and loadConfig extension</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add the following helper functions to gsd-tools.js, placed after the existing helper section (after the `error()` function, before the `// --- Commands ---` section):

1. **`getSessionsDir(overridePath)`** - Resolves the Claude Code sessions directory.
   - Default: `path.join(os.homedir(), '.claude', 'projects')`
   - If `overridePath` provided, use that instead
   - Return the resolved path
   - Check existence with `fs.existsSync()`. If missing, return `null`

2. **`scanProjectDir(projectDirPath)`** - Enumerate all JSONL session files in a project directory.
   - Read directory entries with `fs.readdirSync()`
   - Filter for files ending in `.jsonl`
   - For each: get `fs.statSync()` for `size` and `mtime`
   - Return array of `{ sessionId, filePath, size, modified }` sorted by `modified` descending (most recent first)

3. **`readSessionIndex(projectDirPath)`** - Parse sessions-index.json if present.
   - Try to read `path.join(projectDirPath, 'sessions-index.json')`
   - Parse JSON, extract `originalPath` and `entries` array
   - Build a Map keyed by sessionId for quick lookup
   - On any error (file missing, parse failure): return `{ originalPath: null, entries: new Map() }`

4. **`getProjectName(projectDirName, indexData, firstRecordCwd)`** - Extract human-readable project name.
   - Prefer `indexData.originalPath` -> `path.basename()`
   - Fallback to `firstRecordCwd` -> `path.basename()`
   - Last resort: use `projectDirName` as-is
   - Per research: directory names are lossy (hyphens ambiguous with path separators)

5. **`formatBytes(bytes)`** - Human-readable file size.
   - If bytes < 1024: `N B`
   - If bytes < 1048576: `N.N KB`
   - If bytes < 1073741824: `N.N MB`
   - Else: `N.N GB`

6. **`formatProjectTable(projects)`** - Format project list as human-readable table.
   - Columns: Project (35 chars), Sessions (10 chars), Size (10 chars), Last Active (20 chars)
   - Separator line with dashes
   - Each project row with padEnd alignment
   - Per user decision: "Table format for humans by default"

7. **`formatSessionTable(sessions)`** - Format individual sessions table for `--verbose` mode.
   - Columns: Session ID (40 chars), Size (10 chars), Modified (20 chars)
   - Used when `--verbose` flag is passed

Extend **`loadConfig()`** (at line ~157):
- Add to `defaults` object: `preferences: {}` and `profile: { path: null, generated: null }`
- Add to return object: `preferences: get('preferences') ?? defaults.preferences` and `profile: get('profile') ?? defaults.profile`
- Per PIPE-06: existing config.json files without these keys must still load via backward-compatible defaults

Also add `const os = require('os');` to the top imports if not already present. The `readline` import is not needed in this plan (used in Plan 01-02 for extraction).
  </action>
  <verify>
Run `node get-shit-done/bin/gsd-tools.js --help` (or any existing command like `current-timestamp`) to verify the file still parses and runs without syntax errors. Verify `loadConfig()` returns `preferences` and `profile` keys by checking: `node -e "const path = require('path'); process.chdir('/Users/canodevelopment/coding-portfolio/get-shit-done'); const fs = require('fs'); const src = fs.readFileSync('get-shit-done/bin/gsd-tools.js','utf-8'); console.log(src.includes('preferences') && src.includes('profile'));"` returns true.
  </verify>
  <done>
All 7 helper functions exist in gsd-tools.js. loadConfig() returns `preferences` and `profile` with backward-compatible defaults. File parses without syntax errors. Existing commands still work.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement scan-sessions command with CLI dispatch</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Implement `cmdScanSessions()` and wire it into `main()`:

**`async cmdScanSessions(overridePath, options, raw)`**

Parameters:
- `overridePath`: optional path override (from `--path` flag)
- `options`: `{ json: boolean, verbose: boolean }`
- `raw`: boolean for `--raw` output mode

Logic:
1. Call `getSessionsDir(overridePath)`. If returns null:
   - `error('No Claude Code sessions found at ~/.claude/projects. Is Claude Code installed?')` (per locked decision)

2. Read the sessions directory with `fs.readdirSync()` to get project directories.
   - Filter: only directories (use `fs.statSync().isDirectory()`)
   - Sort by: last active (most recent first) -- per discretion recommendation in research

3. For each project directory:
   a. Call `scanProjectDir()` to get session files
   b. Call `readSessionIndex()` to get index data
   c. Call `getProjectName()` to resolve display name
   d. If no index found AND options are NOT json: write to stderr `"Index not found for ${projectName}, scanning directory..."` (per locked decision)
   e. Calculate aggregate stats:
      - `sessionCount`: number of JSONL files
      - `totalSize`: sum of all file sizes
      - `lastActive`: most recent file modified date (ISO string)
      - `dateRange`: { first: oldest modified, last: newest modified }
   f. If `options.verbose`: list individual sessions per project (enriched with index metadata where available)

4. Build result array of project objects:
   ```
   {
     name: string,
     directory: string,
     sessionCount: number,
     totalSize: number,
     totalSizeHuman: string (from formatBytes),
     lastActive: ISO string,
     dateRange: { first: ISO, last: ISO },
     sessions: (only if verbose) array of session details
   }
   ```

5. Output:
   - If `options.json` or `raw`: `output(result, raw)`
   - Else: print table using `formatProjectTable()`
   - If `options.verbose` and not json: also print session details per project using `formatSessionTable()`

**Main dispatch (add to switch-case in `main()`):**
```javascript
case 'scan-sessions': {
  const jsonFlag = args.includes('--json');
  const verboseFlag = args.includes('--verbose');
  const pathIdx = args.indexOf('--path');
  const sessionsPath = pathIdx !== -1 ? args[pathIdx + 1] : null;
  await cmdScanSessions(sessionsPath, { json: jsonFlag, verbose: verboseFlag }, raw);
  break;
}
```

Place the case before the `default:` case in the main switch.

**Exit codes per locked decisions:**
- 0 for success
- 1 for error (no sessions dir, unreadable)

**Transparency note per locked decision:**
- Before processing, write to stderr: `"Reading your session history (read-only, nothing is modified or sent anywhere)..."`
  </action>
  <verify>
Test the command against actual session data:
1. `node get-shit-done/bin/gsd-tools.js scan-sessions` -- should show a human-readable table with projects
2. `node get-shit-done/bin/gsd-tools.js scan-sessions --json` -- should output valid JSON with project metadata
3. `node get-shit-done/bin/gsd-tools.js scan-sessions --verbose` -- should show individual sessions per project
4. `node get-shit-done/bin/gsd-tools.js scan-sessions --path /nonexistent` -- should show friendly error message
  </verify>
  <done>
`scan-sessions` command returns a table (or JSON with --json) of all Claude Code projects with session counts, sizes, date ranges, and last active timestamps. --verbose lists individual sessions. --path overrides directory. Friendly error when no sessions found. Transparency note displayed on stderr. Exit codes follow the locked decision (0=success, 1=error).
  </done>
</task>

</tasks>

<verification>
Run these checks to verify Plan 01-01 deliverables:

1. **Syntax check:** `node -c get-shit-done/bin/gsd-tools.js` passes (no parse errors)
2. **Existing commands still work:** `node get-shit-done/bin/gsd-tools.js current-timestamp` returns a timestamp
3. **scan-sessions basic:** `node get-shit-done/bin/gsd-tools.js scan-sessions` produces human-readable output
4. **scan-sessions JSON:** `node get-shit-done/bin/gsd-tools.js scan-sessions --json | node -e "JSON.parse(require('fs').readFileSync('/dev/stdin','utf-8'))"` parses as valid JSON
5. **loadConfig extension:** The loadConfig function returns objects with `preferences` and `profile` keys
6. **No-sessions error:** `node get-shit-done/bin/gsd-tools.js scan-sessions --path /tmp/nonexistent` shows friendly error
</verification>

<success_criteria>
- `scan-sessions` command works in human-readable and JSON modes
- `scan-sessions --verbose` shows individual sessions per project
- Discovery works with and without sessions-index.json
- loadConfig() returns `preferences: {}` and `profile: { path: null, generated: null }` by default
- Transparency note displayed on stderr before processing
- Friendly error message when no sessions directory exists
- All existing gsd-tools.js commands continue to work
</success_criteria>

<output>
After completion, create `.planning/phases/01-session-data-pipeline/01-01-SUMMARY.md`
</output>
